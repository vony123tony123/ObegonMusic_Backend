# å®Œæ•´ CI/CD æµç¨‹æ•™å­¸ï¼šExpress + Docker + Jenkins

æœ¬æ–‡ä»¶æ—¨åœ¨æä¾›ä¸€å€‹å®Œæ•´ã€ç¾ä»£åŒ–çš„ CI/CD (æŒçºŒæ•´åˆ/æŒçºŒéƒ¨ç½²) æµç¨‹æ•™å­¸ã€‚æˆ‘å€‘å°‡ä½¿ç”¨ä¸€å€‹åŸºæ–¼ Express.js (TypeScript) çš„å°ˆæ¡ˆï¼Œä¸¦çµåˆ Docker ä¾†å¯¦ç¾ç’°å¢ƒä¸€è‡´æ€§ï¼Œæœ€çµ‚é€é Jenkins è‡ªå‹•åŒ–æ•´å€‹æ¸¬è©¦ã€å»ºç½®èˆ‡éƒ¨ç½²çš„æµç¨‹ã€‚

## æ ¸å¿ƒç†å¿µ

æˆ‘å€‘å°‡åš´æ ¼å€åˆ† **é–‹ç™¼ç’°å¢ƒ** èˆ‡ **ç”Ÿç”¢ç’°å¢ƒ**ï¼š

1.  **é–‹ç™¼ç’°å¢ƒ (Development):**
    *   **ç›®æ¨™:** å¯¦ç¾ã€Œä¸€éµå•Ÿå‹•ã€ï¼ŒåŒ…å«æ‡‰ç”¨ç¨‹å¼å’Œè³‡æ–™åº«ï¼Œä¸¦æä¾›æ¥µè‡´çš„é–‹ç™¼æ•ˆç‡ã€‚
    *   **å·¥å…·:** `docker-compose`
    *   **ç‰¹è‰²:** æ”¯æ´ **ç†±åŠ è¼‰ (Hot Reloading)**ã€‚ç•¶æ‚¨åœ¨æœ¬åœ°ä¿®æ”¹ç¨‹å¼ç¢¼æ™‚ï¼Œæœå‹™æœƒè‡ªå‹•é‡å•Ÿã€‚

2.  **CI/CD & ç”Ÿç”¢ç’°å¢ƒ (Production):**
    *   **ç›®æ¨™:** ç©©å®šã€é«˜æ•ˆã€å¯é æ¸¬çš„å»ºç½®èˆ‡éƒ¨ç½²ã€‚
    *   **å·¥å…·:** `Dockerfile` (å¤šéšæ®µå»ºç½®) + `Jenkinsfile`
    *   **ç‰¹è‰²:** æ•´å€‹æµç¨‹åœ¨ä¹¾æ·¨ã€éš”é›¢çš„ Docker å®¹å™¨ä¸­åŸ·è¡Œï¼Œç¢ºä¿æ¯ä¸€æ¬¡å»ºç½®çš„ç’°å¢ƒéƒ½å®Œå…¨ä¸€è‡´ï¼Œæœ€çµ‚ç”¢å‡ºä¸€å€‹è¼•é‡ã€å®‰å…¨çš„ç”Ÿç”¢ç´š Docker æ˜ åƒ (Image)ã€‚

---

## ğŸ› ï¸ Part 1: ç’°å¢ƒæº–å‚™èˆ‡è¨­å®š

åœ¨é–‹å§‹ä¹‹å‰ï¼Œè«‹ç¢ºä¿æ‚¨çš„é›»è…¦å·²å®‰è£ä»¥ä¸‹è»Ÿé«”ï¼š

*   **Docker Desktop:** ç”¨æ–¼åœ¨æœ¬æ©ŸåŸ·è¡Œ Docker å®¹å™¨ã€‚
*   **Git:** ç”¨æ–¼ç‰ˆæœ¬æ§åˆ¶ã€‚
*   **ç¨‹å¼ç¢¼ç·¨è¼¯å™¨:** ä¾‹å¦‚ VS Codeã€‚

---

## âš™ï¸ Part 2: å°ˆæ¡ˆæ¶æ§‹èˆ‡è‡ªå‹•åŒ–è¨­å®š

æœ¬ç¯€å°‡æ·±åº¦è§£æå°ˆæ¡ˆä¸­çš„æ ¸å¿ƒè¨­å®šæª”æ¡ˆã€‚

### 1. `Dockerfile` (æ˜ åƒå»ºç½®è—åœ–)

æ¡ç”¨äº† **å¤šéšæ®µå»ºç½® (Multi-stage build)** çš„æœ€ä½³å¯¦è¸ï¼Œä»¥å€åˆ†é–‹ç™¼ã€å»ºç½®å’Œç”Ÿç”¢ç’°å¢ƒï¼Œç¢ºä¿æœ€çµ‚æ˜ åƒçš„è¼•é‡èˆ‡å®‰å…¨ã€‚

### 2. `docker-compose.yml` (é–‹ç™¼ç’°å¢ƒå®šç¾©)

æ­¤æª”æ¡ˆæ˜¯æœ¬åœ°é–‹ç™¼çš„æ ¸å¿ƒï¼Œå®ƒå®šç¾©ä¸¦ä¸²é€£äº†æˆ‘å€‘çš„æ‡‰ç”¨ç¨‹å¼æœå‹™ (`dev`) å’Œè³‡æ–™åº«æœå‹™ (`db`)ï¼Œå¯¦ç¾ã€Œä¸€éµå•Ÿå‹•ã€ã€‚

```yaml
# docker-compose.yml
version: '3.8'
services:
  dev:
    build:
      context: .
      target: development
    depends_on:
      db:
        condition: service_healthy
    environment:
      - DB_HOST=db
      # ... å…¶ä»–ç’°å¢ƒè®Šæ•¸
  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=TestDB
      # ... å…¶ä»–è³‡æ–™åº«è¨­å®š
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d TestDB"]
      # ... å¥åº·æª¢æŸ¥è¨­å®š
volumes:
  postgres_data:
```
*   **`services.dev.depends_on`**: ç¢ºä¿ `db` æœå‹™å¥åº·å¾Œï¼Œ`dev` æœå‹™æ‰æœƒå•Ÿå‹•ã€‚
*   **`services.db.volumes`**: 
    1.  `postgres_data`: æŒä¹…åŒ–è³‡æ–™åº«è³‡æ–™ã€‚
    2.  `./docker-entrypoint-initdb.d`: **è‡ªå‹•åŒ–åˆå§‹åŒ–çš„é—œéµ**ã€‚PostgreSQL å®¹å™¨åœ¨é¦–æ¬¡å•Ÿå‹•æ™‚ï¼Œæœƒè‡ªå‹•åŸ·è¡Œæ­¤ç›®éŒ„ä¸‹çš„æ‰€æœ‰ `.sql` è…³æœ¬ã€‚

### 3. è³‡æ–™åº«åˆå§‹åŒ–èˆ‡æ‡‰ç”¨ç¨‹å¼è¨­å®š

*   **`docker-entrypoint-initdb.d/init.sql`**: åœ¨æ­¤æª”æ¡ˆä¸­å®šç¾©æ‚¨çš„ `CREATE TABLE` å’Œ `INSERT` æŒ‡ä»¤ã€‚
*   **`src/config/database.ts`**: ä¿®æ”¹æ­¤æª”æ¡ˆï¼Œä½¿å…¶å¾ `process.env` è®€å–è³‡æ–™åº«é€£ç·šè³‡è¨Šï¼Œä»¥è§£è€¦è¨­å®šã€‚

### 4. `Jenkinsfile` (CI/CD æµæ°´ç·š)

å®šç¾©äº† Jenkins CI/CD æµæ°´ç·šï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨ Docker å®¹å™¨ä¸­å®Œæˆæ‰€æœ‰æ¸¬è©¦å’Œå»ºç½®å·¥ä½œï¼Œç¢ºä¿ç’°å¢ƒä¸€è‡´æ€§ã€‚

---

## ğŸ¤ Part 3: åœ˜éšŠå”ä½œèˆ‡æ¬Šé™ç®¡ç† (Google Groups æœ€ä½³å¯¦è¸)

ç•¶åœ˜éšŠéœ€è¦å…±åŒå­˜å– Google ç›¸é—œæœå‹™ (ä¾‹å¦‚ Google Cloud Platform APIã€æ•¸æ“šåˆ†æç­‰) æ™‚ï¼Œå¦‚ä½•ç®¡ç†æ¬Šé™æ˜¯ä¸€å€‹è‡³é—œé‡è¦çš„å•é¡Œã€‚

### âŒ éŒ¯èª¤çš„åšæ³•ï¼šå…±ç”¨ä¸€å€‹ Google å¸³è™Ÿ

æœ€ç›´è¦ºä½†**æœ€å±éšª**çš„åšæ³•æ˜¯ç”³è«‹ä¸€å€‹å…±ç”¨å¸³è™Ÿ (å¦‚ `my-team@gmail.com`) ä¸¦æŠŠå¯†ç¢¼åˆ†äº«çµ¦æ‰€æœ‰äººã€‚

**ç‚ºä»€éº¼é€™æ˜¯çµ•å°éŒ¯èª¤çš„ï¼Ÿ**
*   **åš´é‡å®‰å…¨é¢¨éšª:** å¯†ç¢¼ä¸€æ—¦å¤–æ´©ï¼Œæ‰€æœ‰è³‡æºéƒ½å°‡æš´éœ²ã€‚å•Ÿç”¨å…©æ­¥é©Ÿé©—è­‰ (2FA) æœƒå°è‡´å–®é»æ•…éšœ (åªæœ‰ä¸€å€‹äººèƒ½æ”¶åˆ°é©—è­‰ç¢¼)ã€‚
*   **ç„¡æ³•è¿½ç©¶è²¬ä»»:** å¦‚æœæœ‰äººèª¤åˆªäº†ç”Ÿç”¢ç’°å¢ƒçš„è³‡æºï¼Œæ‚¨ç„¡æ³•å¾ç´€éŒ„ä¸­å¾—çŸ¥æ˜¯**å“ªä¸€ä½æˆå“¡**æ‰€ç‚ºã€‚
*   **ç®¡ç†æ··äº‚:** ç•¶æœ‰æˆå“¡é›¢é–‹åœ˜éšŠæ™‚ï¼Œæ‚¨å¿…é ˆæ›´æ”¹å¯†ç¢¼ä¸¦é€šçŸ¥æ‰€æœ‰äººï¼Œé€™éå¸¸éº»ç…©ä¸”å®¹æ˜“å‡ºéŒ¯ã€‚

### âœ… æ­£ç¢ºçš„åšæ³•ï¼šä½¿ç”¨ Google Groups é›†ä¸­ç®¡ç†æ¬Šé™

é€™æ˜¯æ¥­ç•Œçš„æ¨™æº–åšæ³•ï¼Œå®‰å…¨ã€é«˜æ•ˆä¸”æ˜“æ–¼ç®¡ç†ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**æ¯å€‹äººéƒ½ç”¨è‡ªå·±çš„ Google å¸³è™Ÿç™»å…¥ï¼Œæ¬Šé™å‰‡ç”±ç¾¤çµ„çµ±ä¸€è³¦äºˆã€‚**

#### æ­¥é©Ÿ 1: å»ºç«‹ä¸€å€‹ Google Group

1.  å‰å¾€ [Google Groups](https://groups.google.com/)ã€‚
2.  é»æ“Š **"å»ºç«‹ç¾¤çµ„"**ã€‚
3.  è¨­å®šç¾¤çµ„è³‡è¨Šï¼š
    *   **ç¾¤çµ„åç¨±:** ä¾‹å¦‚ `My Express App Developers`
    *   **ç¾¤çµ„é›»å­éƒµä»¶:** ä¾‹å¦‚ `my-express-app-devs@googlegroups.com` (é€™å€‹ email å°±æ˜¯æ‚¨ä¹‹å¾Œç”¨ä¾†è¨­å®šæ¬Šé™çš„åœ°å€)
    *   **æ¬Šé™è¨­å®š:** ç‚ºäº†å®‰å…¨ï¼Œå»ºè­°å°‡ã€Œèª°å¯ä»¥æŸ¥çœ‹å°è©±ã€å’Œã€Œèª°å¯ä»¥å¼µè²¼ã€è¨­å®šç‚ºåƒ…é™æˆå“¡ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œã€Œèª°å¯ä»¥åŠ å…¥ç¾¤çµ„ã€æ‡‰è¨­ç‚ºã€Œåƒ…é™å—é‚€è«‹çš„ä½¿ç”¨è€…ã€ã€‚
4.  é»æ“Š **"å»ºç«‹ç¾¤çµ„"**ã€‚

#### æ­¥é©Ÿ 2: å°‡åœ˜éšŠæˆå“¡åŠ å…¥ç¾¤çµ„

1.  åœ¨æ‚¨çš„ç¾¤çµ„é é¢ï¼Œé»æ“Šå·¦å´çš„ **"æˆå“¡"**ã€‚
2.  é»æ“Š **"æ–°å¢æˆå“¡"**ï¼Œä¸¦è¼¸å…¥æ‚¨åœ˜éšŠæˆå“¡çš„**å€‹äºº Google å¸³è™Ÿ**é›»å­éƒµä»¶ã€‚

#### æ­¥é©Ÿ 3: åœ¨ Google Cloud Platform (GCP) ä¸­è³¦äºˆç¾¤çµ„æ¬Šé™

1.  å‰å¾€ [Google Cloud Console](https://console.cloud.google.com/) ä¸¦é¸æ“‡æ‚¨çš„å°ˆæ¡ˆã€‚
2.  åœ¨å·¦å´å°è¦½é¸å–®ä¸­ï¼Œæ‰¾åˆ° **"IAM èˆ‡ç®¡ç†"** > **"IAM"**ã€‚
3.  åœ¨é é¢é ‚éƒ¨ï¼Œé»æ“Š **"æˆäºˆå­˜å–æ¬Š"**ã€‚
4.  åœ¨ **"æ–°å¢ä¸»é«”"** æ¬„ä½ä¸­ï¼Œè²¼ä¸Šæ‚¨å‰›å‰›å»ºç«‹çš„ **Google Group é›»å­éƒµä»¶åœ°å€** (ä¾‹å¦‚ `my-express-app-devs@googlegroups.com`)ã€‚
5.  åœ¨ **"æŒ‡æ´¾è§’è‰²"** ä¸­ï¼Œé¸æ“‡æ‚¨æƒ³è³¦äºˆçš„æ¬Šé™ (ä¾‹å¦‚ï¼Œ**"Editor"** ç·¨è¼¯è€…è§’è‰²)ã€‚
6.  é»æ“Š **"å„²å­˜"**ã€‚

#### å¥½è™•èˆ‡ç¸½çµ

ç¾åœ¨ï¼Œæ‰€æœ‰åœ¨è©²ç¾¤çµ„ä¸­çš„æˆå“¡ï¼Œéƒ½è‡ªå‹•æ“æœ‰äº†å° GCP å°ˆæ¡ˆçš„æ¬Šé™ã€‚ç®¡ç†äººå“¡ç•°å‹•åªéœ€åœ¨ Google Group ä¸­æ“ä½œï¼Œç„¡éœ€åœ¨ GCP ä¸­å–®ç¨ä¿®æ”¹ï¼Œæ¥µå¤§åœ°æå‡äº†ç®¡ç†æ•ˆç‡å’Œå®‰å…¨æ€§ã€‚

---

## ğŸš€ Part 4: æœ¬åœ°é–‹ç™¼ "ä¸€éµå•Ÿå‹•"

1.  **Clone å°ˆæ¡ˆ**ä¸¦é€²å…¥ç›®éŒ„ã€‚
2.  **æº–å‚™åˆå§‹åŒ–è…³æœ¬:** ç¢ºä¿ `docker-entrypoint-initdb.d/init.sql` æª”æ¡ˆä¸­åŒ…å«äº†å°ˆæ¡ˆæ‰€éœ€çš„æ­£ç¢º SQL æŒ‡ä»¤ã€‚
3.  **å•Ÿå‹•å®Œæ•´é–‹ç™¼ç’°å¢ƒ:**
    ```bash
    docker-compose up --build
    ```
4.  **é–‹å§‹é–‹ç™¼:**
    *   æ‡‰ç”¨ç¨‹å¼: `http://localhost:3000`
    *   è³‡æ–™åº« (ä½¿ç”¨å®¢æˆ¶ç«¯): `localhost:5433`
    *   ä¿®æ”¹ `src/` ä¸‹çš„ç¨‹å¼ç¢¼å³å¯è§¸ç™¼ç†±åŠ è¼‰ã€‚
5.  **åœæ­¢é–‹ç™¼ç’°å¢ƒ:** æŒ‰ä¸‹ `Ctrl + C`ï¼Œå¯é¸åŸ·è¡Œ `docker-compose down` ä¾†ç§»é™¤å®¹å™¨ã€‚

---

## ğŸ¤– Part 5: è¨­å®š Jenkins é€²è¡Œ CI/CD

### æ­¥é©Ÿ 1: åŸ·è¡Œ Jenkins å®¹å™¨

```bash
docker run -d \
  -p 8080:8080 \
  -p 50000:50000 \
  -v jenkins_home:/var/jenkins_home \
  -v /var/run/docker.sock:/var/run/docker.sock \
  --name jenkins-server \
  jenkins/jenkins:lts-jdk11
```
*   `-v /var/run/docker.sock:/var/run/docker.sock`: **è‡³é—œé‡è¦**ï¼Œå…è¨± Jenkins å®¹å™¨ä½¿ç”¨ä¸»æ©Ÿçš„ Dockerã€‚

### æ­¥é©Ÿ 2: Jenkins é¦–æ¬¡è¨­å®š

1.  å–å¾—ç®¡ç†å“¡å¯†ç¢¼: `docker exec jenkins-server cat /var/jenkins_home/secrets/initialAdminPassword`
2.  ç€è¦½ `http://localhost:8080` ä¸¦è²¼ä¸Šå¯†ç¢¼ã€‚
3.  é¸æ“‡ **"Install suggested plugins"** ä¸¦å»ºç«‹æ‚¨çš„ç®¡ç†å“¡å¸³è™Ÿã€‚

### æ­¥é©Ÿ 3: å®‰è£ Docker Pipeline æ’ä»¶

å‰å¾€ **Manage Jenkins** > **Plugins** > **Available plugins**ï¼Œæœå°‹ä¸¦å®‰è£ `Docker Pipeline`ã€‚

### æ­¥é©Ÿ 4: å»ºç«‹ Pipeline å°ˆæ¡ˆ

1.  **New Item** > è¼¸å…¥åç¨± > é¸æ“‡ **Pipeline** > **OK**ã€‚
2.  åœ¨ **Pipeline** å€å¡Šï¼Œå°‡ **Definition** æ”¹ç‚º **"Pipeline script from SCM"**ã€‚
3.  **SCM** é¸æ“‡ **Git**ï¼Œä¸¦å¡«å…¥æ‚¨å°ˆæ¡ˆçš„ **Repository URL**ã€‚
4.  ç¢ºèª **Script Path** æ˜¯ `Jenkinsfile`ã€‚
5.  **Save**ã€‚

---

## ğŸ‰ Part 6: è§¸ç™¼ CI/CD æµç¨‹

1.  åœ¨æ‚¨çš„ Pipeline å°ˆæ¡ˆé é¢ï¼Œé»æ“Šå·¦å´çš„ **Build Now**ã€‚
2.  åœ¨ **Stage View** ä¸­è§€å¯Ÿ Checkout, Test, Build ç­‰éšæ®µçš„åŸ·è¡Œéç¨‹ã€‚

æ­å–œï¼æ‚¨å·²æˆåŠŸå»ºç«‹äº†ä¸€å€‹å¾æœ¬åœ°é–‹ç™¼ã€åœ˜éšŠå”ä½œåˆ°è‡ªå‹•åŒ– CI/CD çš„å®Œæ•´ä¸”å°ˆæ¥­çš„æµç¨‹ã€‚